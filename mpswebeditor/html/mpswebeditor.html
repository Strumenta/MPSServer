<html>
<head>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/baseLanguage_stylepack.css">
    <script src="../js/jquery-3.4.1.min.js"></script>
    <script src="../js/jquery.caret.min.js"></script>
    <script src="../js/editor_model.js"></script>
    <script src="../js/projectional_editor.js"></script>
</head>
<body>
<div class="editor" id="mainEditor">

</div>
<script>

    function insertCharInString(s, c, i) {
        return s.substring(0, i) + c + s.substring(i, s.length);
    }

    function makeConceptAbstract() {
        //$("#cell_0_0").prepend("<div class=\"com.strumenta.mpswebeditor.constant keyword\" contenteditable>abstract</div>");
        window.editorModelAPI.makeConceptAbstract();
        window.editorAPI.updateEditorModel(window.editorModelAPI.getCurrentModel());
    }

    function makeConceptFinal() {
        $("#cell_0_0").prepend("<div class=\"com.strumenta.mpswebeditor.constant keyword\" contenteditable>final</div>");
    }

    function removeEditing() {
        $(".editing").remove();
    }

    function checkEditing(element) {
        // if (element.text() === "abstract") {
        //     removeEditing();
        //     makeConceptAbstract();
        // }
        // if (element.text() === "final") {
        //     removeEditing();
        //     makeConceptFinal();
        // }
        console.log("Check editing " + element);

        let cellID = window.editorAPI.cellIdToPath(element.parent()[0].id);
        let completions = window.editorModelAPI.completionsFor(cellID);
        let text = element.text();
        let found = false;
        $.each(completions, function (key, value) {
            if (value.text === text && !found) {
                window.editorModelAPI.triggerAction(value.action);
                found = true;
                removeEditing();
            }
        });
    }

    let keypressReactor = function (e) {
        let pos = $(this).caret('pos');
        let hasEditingSpan = $('.com.strumenta.mpswebeditor.constant').children().length !== 0;
        let c = String.fromCharCode(e.which)
        //console.log("on com.strumenta.mpswebeditor.constant " + pos + ", has span? " + hasEditingSpan);
        if (hasEditingSpan) {
            let spanLength = $('.com.strumenta.mpswebeditor.constant').children().text().length
            //console.log("span length " + spanLength);
            if (pos < spanLength) {
                $('.com.strumenta.mpswebeditor.constant').children().text(insertCharInString($('.com.strumenta.mpswebeditor.constant').children().text(), c, pos));
                $(this).caret('pos', pos + 1);
            } else if (pos == spanLength) {
                $('.com.strumenta.mpswebeditor.constant').children().text($('.com.strumenta.mpswebeditor.constant').children().text() + c);
            }
        } else {
            if (pos === 0) {
                $(this).prepend("<span class='editing' contenteditable>" + c + "</span>");
            }
        }
        checkEditing($('.com.strumenta.mpswebeditor.constant').children());
        e.preventDefault();
    };

    window.onload = function() {
        window.editorModelAPI = editorModelAPI();
        window.editorAPI = editorAPI($("#mainEditor"));
        //window.editorAPI.updateEditorModel(window.editorModelAPI.getCurrentModel());
        $(".com.strumenta.mpswebeditor.constant").bind("keypress", keypressReactor);
        //window.editorModelAPI.registerForUpdates();
        window.editorModelAPI.setModelUpdateHandler(function(model){
            window.editorAPI.updateEditorModel(model);
        });
        window.editorModelAPI.start();
    }
</script>
</body>
</html>