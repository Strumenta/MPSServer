<html>
<head>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/baseLanguage_stylepack.css">
    <script src="../js/jquery-3.4.1.min.js"></script>
    <script src="../js/jquery.caret.min.js"></script>
    <!--<link rel="stylesheet" href="../css/raster.css">-->
</head>
<body>
<div class="editor">
    <div class="vertical_list" id="cell_1">
        <div class="horizontal_list" id="cell_2">
            <!-- space in the constant cause mess with the caret -->
            <div class="constant keyword" contenteditable>concept</div>
            <div class="string_property" contenteditable>
                EqualTo
            </div>
            <div class="vertical_list">
                <div class="constant keyword">extends
                </div>
                <div class="constant keyword">
                    implements
                </div>
            </div>
            <div class="vertical_list">
                <div class="string_property" contenteditable>
                    Constraint
                </div>
                <div class="placeholder">
                    none
                </div>
            </div>
        </div>
        <!-- empty line --> <div class="constant"> </div>
        <div class="horizontal_list">
            <div class="spacer">

            </div>
            <div class="vertical_list">
                <div class="horizontal_list">
                    <div class="constant">
                    instance can be root:
                    </div>
                    <div class="string_property" contenteditable>
                        false
                    </div>
                </div>
                <div class="horizontal_list">
                    <div class="constant">
                        alias:
                    </div>
                    <div class="string_property" contenteditable>
                        =
                    </div>
                </div>
                <div class="horizontal_list">
                    <div class="constant">
                        short description:
                    </div>
                    <div class="placeholder">
                        &lt;no short description&gt;
                    </div>
                </div>
                <!-- empty line --> <div class="constant"> </div>
                <div class="constant">
                    properties:
                </div>
                <div class="placeholder">
                    &lt;&lt; ... &gt;&gt;
                </div>
                <!-- empty line --> <div class="constant"> </div>
                <div class="constant">
                    children:
                </div>
                <div class="placeholder">
                    &lt;&lt; ... &gt;&gt;
                </div>
                <!-- empty line --> <div class="constant"> </div>
                <div class="constant">
                    references:
                </div>
                <div class="placeholder">
                    &lt;&lt; ... &gt;&gt;
                </div>
                <!-- empty line --> <div class="constant"> </div>
            </div>
        </div>
    </div>
</div>
<script>
    function getCaretPosition(editableDiv) {
        let caretPos = 0,
            sel, range;
        if (window.getSelection) {
            sel = window.getSelection();
            if (sel.rangeCount) {
                console.log("A1");
                range = sel.getRangeAt(0);
                if (range.commonAncestorContainer.parentNode === editableDiv) {
                    console.log("A2 " +sel.rangeCount + " "+ range.endOffset);
                    caretPos = range.endOffset;
                }
            }
        } else if (document.selection && document.selection.createRange) {
            range = document.selection.createRange();
            if (range.parentElement() === editableDiv) {
                const tempEl = document.createElement("span");
                editableDiv.insertBefore(tempEl, editableDiv.firstChild);
                const tempRange = range.duplicate();
                tempRange.moveToElementText(tempEl);
                tempRange.setEndPoint("EndToEnd", range);
                caretPos = tempRange.text.length;
            }
        }
        return caretPos;
    }

    function insertCharInString(s, c, i) {
        return s.substring(0, i) + c + s.substring(i, s.length);
    }

    function makeConceptAbstract() {
        $("#cell_2").prepend("<div class=\"constant keyword\" contenteditable>abstract</div>");
    }

    function removeEditing() {
        $(".editing").remove();
    }

    function checkEditing(element) {
        if (element.text() === "abstract") {
            removeEditing();
            makeConceptAbstract();
        }
    }

    $(".constant").bind("keypress",function(e){
        let pos = $(this).caret('pos');
        let hasEditingSpan = $('.constant').children().length !== 0;
        let c = String.fromCharCode(e.which)
        //console.log("on constant " + pos + ", has span? " + hasEditingSpan);
        if (hasEditingSpan) {
            let spanLength = $('.constant').children().text().length
            //console.log("span length " + spanLength);
            if (pos < spanLength) {
                $('.constant').children().text(insertCharInString($('.constant').children().text(), c, pos));
                $(this).caret('pos', pos + 1);
            } else if (pos == spanLength) {
                $('.constant').children().text($('.constant').children().text() + c);
            }
        } else {
            if (pos === 0) {
                $(this).prepend("<span class='editing' contenteditable>" + c + "</span>");
            }
        }
        checkEditing($('.constant').children());
        e.preventDefault();
    });
</script>
</body>
</html>