<html>
<head>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/baseLanguage_stylepack.css">
    <script src="../js/jquery-3.4.1.min.js"></script>
    <script src="../js/jquery.caret.min.js"></script>
    <script src="../js/editor_model.js"></script>
    <script src="../js/projectional_editor.js"></script>
</head>
<body>
<div class="editor" id="mainEditor">

</div>
<script>

    function insertCharInString(s, c, i) {
        return s.substring(0, i) + c + s.substring(i, s.length);
    }

    function makeConceptAbstract() {
        //$("#cell_0_0").prepend("<div class=\"constant keyword\" contenteditable>abstract</div>");
        window.editorModelAPI.makeConceptAbstract();
        window.editorAPI.updateEditorModel(window.editorModelAPI.getCurrentModel());
    }

    function makeConceptFinal() {
        $("#cell_0_0").prepend("<div class=\"constant keyword\" contenteditable>final</div>");
    }

    function removeEditing() {
        $(".editing").remove();
    }

    function checkEditing(element) {
        // if (element.text() === "abstract") {
        //     removeEditing();
        //     makeConceptAbstract();
        // }
        // if (element.text() === "final") {
        //     removeEditing();
        //     makeConceptFinal();
        // }
        console.log("Check editing " + element);

        let cellID = window.editorAPI.cellIdToPath(element.parent()[0].id)
        var completions = window.editorModelAPI.completionsFor(cellID);
    }

    let keypressReactor = function (e) {
        let pos = $(this).caret('pos');
        let hasEditingSpan = $('.constant').children().length !== 0;
        let c = String.fromCharCode(e.which)
        //console.log("on constant " + pos + ", has span? " + hasEditingSpan);
        if (hasEditingSpan) {
            let spanLength = $('.constant').children().text().length
            //console.log("span length " + spanLength);
            if (pos < spanLength) {
                $('.constant').children().text(insertCharInString($('.constant').children().text(), c, pos));
                $(this).caret('pos', pos + 1);
            } else if (pos == spanLength) {
                $('.constant').children().text($('.constant').children().text() + c);
            }
        } else {
            if (pos === 0) {
                $(this).prepend("<span class='editing' contenteditable>" + c + "</span>");
            }
        }
        checkEditing($('.constant').children());
        e.preventDefault();
    };

    window.onload = function() {
        window.editorModelAPI = editorModelAPI();
        window.editorAPI = editorAPI($("#mainEditor"));
        window.editorAPI.updateEditorModel(window.editorModelAPI.getCurrentModel());
        $(".constant").bind("keypress", keypressReactor);
    }
</script>
</body>
</html>